<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby9nk4fuhcSM8HAdjqIcj1vt1QfuEWITv_3COPWjajPCTyCXeD0nVMnMXy62vyWAWGJnA/exec';

let currentSheet = 0;

function parseMaybeJson(response) {
  const ct = response.headers.get('content-type') || '';
  if (ct.includes('application/json')) {
    return response.json();
  }
  // fallback: try text then parse
  return response.text().then(txt => {
    try {
      return JSON.parse(txt);
    } catch (e) {
      // ë°˜í™˜ê°’ì´ JSONì´ ì•„ë‹Œ í‰ë¬¸ì¸ ê²½ìš°, ê·¸ëŒ€ë¡œ í…ìŠ¤íŠ¸ë¥¼ ë¦¬í„´
      return txt;
    }
  });
}

function login() {
  const pw = document.getElementById('pass').value.trim();
  const url = `${WEBAPP_URL}?action=login&password=${encodeURIComponent(pw)}`;

  fetch(url, { method: 'GET' })
    .then(res => {
      if (!res.ok) throw new Error('Network response was not ok: ' + res.status);
      return parseMaybeJson(res);
    })
    .then(res => {
      // resê°€ ë¬¸ìì—´("OK" ë“±)ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ íƒ€ì… ì²´í¬
      if (typeof res === 'string') {
        console.warn('ì„œë²„ê°€ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤:', res);
        alert('ì„œë²„ ì‘ë‹µì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤. (ë””ë²„ê·¸: ì½˜ì†” í™•ì¸)');
        return;
      }

      if (!res || res.success === false) {
        alert('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');
        return;
      }

      // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');

      const pb = document.getElementById('protectBtn');
      if (pb) pb.remove();

      if (res.name || res.data) {
        document.getElementById('sheet-name').innerText = 'ğŸ“„ ' + (res.name || '');
        makeTable(res.data || []);
      } else {
        loadSheet(0);
      }
    })
    .catch(err => {
      alert('í†µì‹  ì˜¤ë¥˜');
      console.error('login fetch error:', err);
    });
}

/* ì‹œíŠ¸ ë¡œë“œ (GET-based) */
function loadSheet(idx) {
  currentSheet = idx;
  document.getElementById('searchInput').value = '';
  const url = `${WEBAPP_URL}?action=getSheetByIndex&index=${encodeURIComponent(idx)}`;

  fetch(url, { method: 'GET' })
    .then(res => {
      if (!res.ok) throw new Error('Network response was not ok: ' + res.status);
      return parseMaybeJson(res);
    })
    .then(res => {
      if (typeof res === 'string') {
        console.warn('ì„œë²„ê°€ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤:', res);
        alert('ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨: ì„œë²„ ì‘ë‹µì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.');
        return;
      }

      if (!res || res.success === false) {
        alert('ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + (res && res.msg ? res.msg : 'unknown'));
        return;
      }
      document.getElementById('sheet-name').innerText = 'ğŸ“„ ' + (res.name || '');
      makeTable(res.data || []);
    })
    .catch(err => {
      alert('í†µì‹  ì˜¤ë¥˜');
      console.error('loadSheet fetch error:', err);
    });
}

/* ìŠ¤ì™‘ */
function swapSheet() {
  loadSheet(currentSheet === 0 ? 1 : 0);
}

/* í…Œì´ë¸” */
function makeTable(data) {
  let html = '<div class="table-wrap"><table><tbody>';
  data.forEach(r => {
    html += '<tr>';
    r.forEach(c => html += `<td>${c ?? ''}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  document.getElementById('table-container').innerHTML = html;
}

/* ê²€ìƒ‰ */
function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('#table-container tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
}
</script>
